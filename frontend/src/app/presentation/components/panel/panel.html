<!-- üîç SEARCH BAR (solo para clientes y cuentas) -->
@if (screen !== 'movements' && screen !== 'reports') {
  <section class="searchContainer">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      name="searchText"
      class="searchText"
      placeholder="Buscar"
      (keyup.enter)="onSearch()"
    />
    <span class="searchBtn" (click)="onSearch()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
        <path d="M448 449L301.2 300.2c20-27.9 31.9-62.2 31.9-99.2 0-93.1-74.7-168.9-166.5-168.9-91.9-.1-166.6 75.7-166.6 168.8S74.7 369.8 166.5 369.8c39.8 0 76.3-14.2 105-37.9L417.5 480 448 449zM166.5 330.8c-70.6 0-128.1-58.3-128.1-129.9S95.9 71 166.5 71 294.6 129.3 294.6 200.9 237.2 330.8 166.5 330.8z"/>
      </svg>
    </span>
  </section>
}

<!-- üî• FILTERS REPORTS -->
@if (screen === 'reports') {
  <section class="movementFormContainer">
    <form class="movementForm" (ngSubmit)="onSearch()">
      <div class="mfGroup">
        <label>Cliente</label>
        <select [(ngModel)]="reportFilters.clientName" name="clientName">
          <option value="">Seleccionar...</option>
          @for (opt of selectOptions['client'] || []; track opt.value) {
            <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>

      <div class="mfGroup">
        <label>Fecha inicio</label>
        <input type="date" [(ngModel)]="reportFilters.startDate" name="startDate" required />
      </div>

      <div class="mfGroup">
        <label>Fecha fin</label>
        <input type="date" [(ngModel)]="reportFilters.endDate" name="endDate" required />
      </div>

      <div class="mfGroup" style="align-self:flex-end;">
        <button type="button" class="mfBtn" (click)="onSearch()" title="Buscar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" style="width:18px;height:18px;">
            <path d="M448 449L301.2 300.2c20-27.9 31.9-62.2 31.9-99.2 0-93.1-74.7-168.9-166.5-168.9-91.9-.1-166.6 75.7-166.6 168.8S74.7 369.8 166.5 369.8c39.8 0 76.3-14.2 105-37.9L417.5 480 448 449zM166.5 330.8c-70.6 0-128.1-58.3-128.1-129.9S95.9 71 166.5 71 294.6 129.3 294.6 200.9 237.2 330.8 166.5 330.8z"/>
          </svg>
        </button>
      </div>
    </form>
  </section>
}

<!-- üî• MOVEMENTS FORM -->
@if (screen === 'movements') {
  <section class="movementFormContainer">
    <form class="movementForm" (ngSubmit)="submitMovement()">
      <div class="mfGroup">
        <label>Tipo</label>
        <select [(ngModel)]="movementData.movementType" name="movementType" required>
          <option value="" disabled>Seleccionar...</option>
          <option value="Debito">D√©bito</option>
          <option value="Credito">Cr√©dito</option>
        </select>
      </div>

      <div class="mfGroup">
        <label>Cuenta</label>
        <select [(ngModel)]="movementData.account" name="account" (ngModelChange)="onAccountChange()" required>
          <option value="" disabled>Seleccionar...</option>
          @for (acc of accountsList; track acc.id) {
            <option [ngValue]="acc.id">{{ acc.accountNumber }}</option>
          }
        </select>
      </div>

      <div class="mfGroup">
        <label>Saldo</label>
        <input type="number" [(ngModel)]="movementData.balance" name="balance" readonly />
      </div>

      <div class="mfGroup">
        <label>Monto</label>
        <input type="number" [(ngModel)]="movementData.amount" name="amount" required />
      </div>

      <button type="submit" class="mfBtn">Registrar</button>
    </form>
  </section>
}

<!-- üî• TABLE -->
<div class="dataTable">

  <!-- ADD / EXPORT BUTTON -->
  @if (screen !== 'movements') {
    <span class="addBtn" (click)="screen === 'reports' ? exportReport() : openForm()">
      @if (screen === 'reports') {
        <!-- ICONO EXPORT -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 242.7-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5 12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7 288 32z"/>
        </svg>
      } @else {
        <!-- ICONO ADD -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
          <path d="M256 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 160-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0 0-160z"/>
        </svg>
      }
    </span>
  }

  <table>
    <thead>
      <tr>
        @for (col of headers; track col.key) {
          <th>{{ col.header }}</th>
        }
        @if (screen !== 'movements') { <th></th> }
      </tr>
    </thead>

    <tbody>
      @for (row of data; track row.id || row.accountNumber) {
        <tr (click)="screen !== 'movements' && screen !== 'reports' ? selectRow(row) : null" 
            [class.selectedRow]="selectedRow?.id === row.id">

          @for (col of headers; track col.key) {
            <td>{{ col.key === 'status' ? (row[col.key] ? 'Activo' : 'Inactivo') : row[col.key] }}</td>
          }

          <!-- EDIT / DELETE SOLO PARA CLIENTES Y CUENTAS -->
          @if (screen === 'clients' || screen === 'accounts') {
            <td class="editRemoveBtns">
              <svg (click)="openEditForm(row); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M290.74 93.24l128 128-233.37 233.37-128 0 0-128 233.37-233.37zM497.94 74.16c18.75-18.75 18.75-49.14 0-67.88l-60.12-60.12c-18.75-18.75-49.14-18.75-67.88 0l-46.06 46.06 128 128 46.06-46.06z"/>
              </svg>
              <svg (click)="deleteRow(row); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                <path d="M135.2 17.7C140.6 7 151.7 0 163.6 0h120.7c11.9 0 23 7 28.4 17.7L328 32H432c8.8 0 16 7.2 16 16s-7.2 16-16 16h-16l-21.2 372.1c-1.3 23-20.7 41.9-43.7 41.9H96.9c-23 0-42.4-18.9-43.7-41.9L32 64H16c-8.8 0-16-7.2-16-16s7.2-16 16-16h104l14.2-14.3z"/>
              </svg>
            </td>
          }
        </tr>
      }
    </tbody>
  </table>

  <!-- PAGINACION ORIGINAL RESTAURADA -->
  <div class="pagination">
    <svg (click)="prevPage()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
    <span class="currentPage">{{ currentPage + 1 }} / {{ totalPages }}</span>
    <svg (click)="nextPage()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><path d="M247.1 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L179.2 256 41.9 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg>
  </div>
  <span class="paginationInfo">Mostrando {{ rangeStart }} a {{ rangeEnd }} de {{ totalElements }} registros</span>
</div>

<!-- DETAIL CARD only for clients & accounts -->
@if (selectedRow && screen !== 'movements' && screen !== 'reports') {
  <div class="detailCard">
    <span class="detailClose" (click)="selectedRow = null">&times;</span>
    <h3>Detalle</h3>
    <div class="detailGrid">
      @for (field of detailFields; track field.key) {
        <div class="detailItem">
          <span class="detailLabel">{{ field.label }}</span>
          <span class="detailValue">{{ getDisplayValue(selectedRow, field) }}</span>
        </div>
      }
    </div>
  </div>
}

<!-- MODAL FORM only for clients & accounts -->
@if (showForm && screen !== 'movements' && screen !== 'reports') {
  <div class="formOverlay" (click)="closeForm()"></div>
  <div class="formPanel">
    <h3>{{ isEditing ? 'Editar registro' : 'Nuevo registro' }}</h3>
    <form (ngSubmit)="submitForm()">
      @for (field of formFields; track field.key) {
        <div class="formGroup">
          @if (field.type === 'checkbox') {
            <label class="checkboxLabel">
              <input type="checkbox" [(ngModel)]="formData[field.key]" [name]="field.key">
              {{ field.label }}
            </label>
          } @else if (field.type === 'select') {
            <label>{{ field.label }}</label>
            <select [(ngModel)]="formData[field.key]" [name]="field.key" required>
              <option value="" disabled>Seleccionar...</option>
              @for (opt of (field.options || selectOptions[field.key] || []); track opt.value) {
                <option [ngValue]="opt.value">{{ opt.label }}</option>
              }
            </select>
          } @else {
            <label>{{ field.label }}</label>
            <input [type]="field.type" [(ngModel)]="formData[field.key]" [name]="field.key" required>
          }
        </div>
      }
      <div class="formActions">
        <button type="button" class="btnCancel" (click)="closeForm()">Cancelar</button>
        <button type="submit" class="btnSave">Guardar</button>
      </div>
    </form>
  </div>
}